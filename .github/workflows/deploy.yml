name: Deploy to Digital Ocean Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ Starting deployment to app.aisaturn.co..."
            
            # Navigate to application directory
            cd /var/www/chatwoot
            
            # Pull latest code from GitHub
            echo "üì• Pulling latest code from GitHub main branch..."
            git fetch origin main
            git reset --hard origin/main
            
            # Load Ruby environment (rbenv) and set correct version
            export PATH="$HOME/.rbenv/bin:$PATH"
            eval "$(rbenv init -)"
            rbenv install 3.2.2 --skip-existing
            rbenv local 3.2.2
            
            # Load environment variables from .env.production
            # (Already configured on server - no need to pass secrets)
            source /var/www/chatwoot/.env.production || true
            
            # Install Ruby dependencies
            echo "üì¶ Installing Ruby gems (bundle install)..."
            bundle install --deployment --without development test
            
            # Install Node dependencies
            echo "üì¶ Installing Node packages (pnpm install)..."
            pnpm install --frozen-lockfile
            
            # Clean ALL caches to force fresh build
            echo "üßπ Cleaning all caches..."
            rm -rf tmp/vite-cache
            rm -rf tmp/cache
            rm -rf public/vite*
            rm -rf public/packs
            rm -rf public/assets
            
            # Precompile assets for production (with complete clean)
            echo "üé® Precompiling Vite and Rails assets..."
            RAILS_ENV=production bundle exec rails assets:clobber || true
            RAILS_ENV=production BUILD_MODE=library bin/vite build --force
            RAILS_ENV=production bin/vite build --force
            RAILS_ENV=production bundle exec rails assets:precompile
            
            # Run database migrations
            echo "üóÑÔ∏è Running database migrations..."
            RAILS_ENV=production bundle exec rails db:migrate
            
            # Configure AISATURN branding in database
            echo "üé® Setting up AISATURN branding..."
            RAILS_ENV=production bundle exec rails runner "
              InstallationConfig.find_or_initialize_by(name: 'LOGO').update!(value: '/brand-assets/new_logo.png', locked: false)
              InstallationConfig.find_or_initialize_by(name: 'LOGO_DARK').update!(value: '/brand-assets/new_logo_dark.png', locked: false)
              InstallationConfig.find_or_initialize_by(name: 'LOGO_THUMBNAIL').update!(value: '/brand-assets/new_logo.png', locked: false)
              InstallationConfig.find_or_initialize_by(name: 'BRAND_NAME').update!(value: 'AISATURN', locked: false)
              InstallationConfig.find_or_initialize_by(name: 'BRAND_URL').update!(value: 'https://app.aisaturn.co', locked: false)
              InstallationConfig.find_or_initialize_by(name: 'INSTALLATION_NAME').update!(value: 'AISATURN', locked: false)
              GlobalConfig.clear_cache
              puts '‚úÖ AISATURN branding configured!'
            "
            
            # Restart Chatwoot services
            echo "üîÑ Restarting Chatwoot web and worker services..."
            sudo systemctl restart chatwoot-web
            sudo systemctl restart chatwoot-worker
            
            # Wait for services to start
            sleep 3
            
            # Check service status
            echo "‚úÖ Checking service status..."
            sudo systemctl status chatwoot-web --no-pager || true
            sudo systemctl status chatwoot-worker --no-pager || true
            
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Application is now live at https://app.aisaturn.co"
